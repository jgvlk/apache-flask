<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>myplaid - Accounts</title>
    <base href="/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="static/img/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
    <style>
        html body {
            font-family: "Raleway";
        }

        .jv-outline-element {
            margin: auto;
            border: 3px solid black;
            padding: 10px;
            text-align: center;
        }
    </style>
</head>

<body onload="getAccounts()" style="background-color: #EFF8FC;">
    <h1>Connect</h1>
    <div>
        <p id="intro">
            A web application for integration with Plaid's Link module.
        </p>
    </div>
    <div>
        <p style="font-size: smaller;">
            Click button to login to your institution:
            <button id="launch-link-create">Launch Link</button>
        </p>
    </div>
    <hr>
    <div>
        <h2>Linked Accounts</h2>
        <pre id="data-display">
            <!-- Dispaly account data here -->
        </pre>
    </div>
    <hr>
    <p>
        <div>
            <a href="/">Home</a>
        </div>
    </p>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <script type="text/javascript">
        const btnLaunchLink = document.querySelector('button')
        const dataDisplay = document.getElementById('data-display')

        function getAccounts() {
            const request = new XMLHttpRequest();

            fetch('https://localhost:8443/api/getAccounts')
                .then(response => response.json())
                .then(function (data) {
                    var accountsResponse = JSON.parse(data);
                    const accounts = accountsResponse.response;

                    dataDisplay.textContent = JSON.stringify(accountsResponse.response, undefined, 4);
                    console.log(accounts);
                })
                .catch(function (err) {
                    console.log('Fetch problem: ' + err.message);
                });
        }

        btnLaunchLink.onclick = async function () {
            let response = await fetch('https://localhost:8443/api/createLinkToken', {
                method: 'POST'
            });

            let token = await response.json();

            var createHandler = Plaid.create({
                token: await token,
                onSuccess: function (public_token, metadata) {
                    fetch('https://localhost:8443/api/addAccount', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json;charset=utf-8'
                            },
                            body: JSON.stringify(public_token)
                        })
                        .then(response => response.json())
                        .then(function (data) {
                            console.log(data);
                        });
                    console.log('public_token: ' + public_token);
                    console.log(metadata);
                },
                onExit: function (err, metadata) {
                    if (err != null) {
                        console.log('error' + err);
                    }
                }
            });

            createHandler.open();

        };
    </script>
</body>

</html>